---
title: "[BIN] DockerCompose"
date: 2023-12-27T13:20:04+08:00
draft: true
weight: 40
---

# [BIN] DockerCompose

```bash
source /opt/k8s/.env

cat > /opt/k8s/docker-compose.yaml << EOF
version: "3.3"

services: 
  etcd-server:
    image: registry.aliyuncs.com/google_containers/etcd:3.5.9-0
    restart: always
    command:
      - etcd
      - --data-dir=/var/lib/etcd
      - --listen-client-urls=https://0.0.0.0:2379
      - --advertise-client-urls=https://0.0.0.0:2379 
      - --cert-file=/etc/etcd/cert/etcd.crt
      - --key-file=/etc/etcd/cert/etcd.key
      - --trusted-ca-file=/etc/etcd/cert/ca.crt
      - --client-cert-auth
      - --max-request-bytes=4194304
    volumes:
      - /opt/k8s/cert:/etc/etcd/cert/
      - /var/lib/etcd:/var/lib/etcd
    ports:
      - 2379:2379
  
  kube-apiserver:
    image: registry.aliyuncs.com/google_containers/kube-apiserver:v1.28.5
    restart: always
    command:
      - kube-apiserver
      - --advertise-address=0.0.0.0
      - --allow-privileged=true
      - --anonymous-auth=false
      - --authorization-mode=Node,RBAC
      - --client-ca-file=/etc/kubernetes/pki/ca.crt
      - --enable-admission-plugins=NodeRestriction
      - --enable-bootstrap-token-auth=true
      - --etcd-cafile=/etc/kubernetes/pki/ca.crt
      - --etcd-certfile=/etc/kubernetes/pki/kubernetes.crt
      - --etcd-keyfile=/etc/kubernetes/pki/kubernetes.key
      - --etcd-servers=https://${NODEIP}:2379
      - --kubelet-client-certificate=/etc/kubernetes/pki/kubernetes.crt
      - --kubelet-client-key=/etc/kubernetes/pki/kubernetes.key
      - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
      - --secure-port=6443
      - --service-account-issuer=https://kubernetes.default.svc.cluster.local
      - --service-account-key-file=/etc/kubernetes/pki/ca.crt
      - --service-account-signing-key-file=/etc/kubernetes/pki/ca.key
      - --service-cluster-ip-range=10.96.0.0/12,2001:db8:41:1::/112
      - --tls-cert-file=/etc/kubernetes/pki/kubernetes.crt
      - --tls-private-key-file=/etc/kubernetes/pki/kubernetes.key
    volumes:
      - /opt/k8s/cert:/etc/kubernetes/pki/
    ports:
      - 6443:6443
EOF
```

验证：

```bash
etcdctl -w table --cacert=/opt/k8s/cert/ca.crt --cert=/opt/k8s/cert/etcd.crt \
  --key=/opt/k8s/cert/etcd.key --endpoints 127.0.0.1:2379 endpoint status
```